<!DOCTYPE html><!--
Copyright 2021 James Deery
Released under the MIT licence, https://opensource.org/licenses/MIT
--><html lang="en"><head><title>M8 Display</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="theme-color" content="#000"><link rel="shortcut icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAABlBMVEUAAAAA7/9Rg7lhAAAAHklEQVQI12NgQAJKNgxmLgxaLgxKNQxKLmBUwYAKAFHoA0vrVbyeAAAAAElFTkSuQmCC"><link rel="apple-touch-icon" href="icon.png"><link rel="manifest" href="app.webmanifest"><style>
@font-face{font-family:"m8stealth57";src:url("data:font/woff2;base64,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") format("woff2")}body{font-family:sans-serif;background-color:#000;color:#eee;margin:0px;font-size:16px}a,a:visited{color:#00efff;text-decoration:none}a:hover,a:visited:hover{text-decoration:underline}a:focus,a:visited:focus{outline:1px solid #00efff}kbd{font-family:sans-serif;background-color:#444;color:#00efff;font-size:16px;margin:0 2px;padding:2px 5px;border-radius:3px}.hidden{display:none}label,input,select,button{appearance:none;font-family:"m8stealth57";font-size:14px;background-color:#000;color:#fff}label:hover,input:hover,select:hover,button:hover{background-color:#00efff;color:#000}label:active,input:active,select:active,button:active{background-color:#00bfcc;color:#fff}label:focus,label:focus-within,input:focus,input:focus-within,select:focus,select:focus-within,button:focus,button:focus-within{outline:none;color:#00efff}label:focus:hover,label:focus-within:hover,input:focus:hover,input:focus-within:hover,select:focus:hover,select:focus-within:hover,button:focus:hover,button:focus-within:hover{color:#000}label:focus:active,label:focus-within:active,input:focus:active,input:focus-within:active,select:focus:active,select:focus-within:active,button:focus:active,button:focus-within:active{color:#fff}button{border:3px solid #fff;padding:20px}input[type=checkbox]{font-family:"m8stealth57"}input[type=checkbox]::after{content:"OFF"}input[type=checkbox]:checked::after{content:"ON"}input[type=file]{border:3px solid #fff;padding:20px}select{padding:5px 32px 5px 5px;background-color:rgba(0,0,0,0);background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23fff' stroke-width='3' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 10px center;background-size:16px;font-family:sans-serif;font-size:12px}progress{border:3px solid #fff;height:40px;width:100%}progress::-webkit-progress-bar{background-color:#000}progress::-webkit-progress-value{background-color:#00efff}#display{position:relative;width:100vw;height:75vw;max-width:133.3333333333vh;max-height:100vh;margin:0 auto;top:0;bottom:0;left:0;right:0;user-select:none}#display canvas,#display svg{position:absolute;width:100%;height:100%}#display canvas{image-rendering:pixelated}#display svg text{font-family:"m8stealth57";font-size:16px}#display #buttons{position:absolute;top:25px;width:100%;text-align:center}body.mapping #display #buttons{display:none}#display #mapping-buttons{display:none;position:absolute;top:25px;width:100%;text-align:center}body.mapping #display #mapping-buttons{display:block}#display #mapping-buttons button{margin:0 5px 10px}#display.with-controls,body.mapping #display{height:150vw;max-width:66.6666666667vh}#display.with-controls canvas,#display.with-controls svg,body.mapping #display canvas,body.mapping #display svg{height:50%}#display.with-controls #controls,body.mapping #display #controls{display:block}#display #controls{display:none;position:relative;width:100%;height:50%;top:50%}#display #controls>div{position:absolute;width:20.3125%;height:27.0833%;border:3px solid #aaa;border-radius:10px;background-color:#333;box-sizing:border-box;padding:5px;text-align:center;font-size:80%;transition-property:border-color,background-color;transition-duration:200ms}#display #controls>div.active{border-color:#0cf;background-color:#0cf;transition-duration:0s}#display #controls>div.active[data-action=edit]{border-color:#d48;background-color:#d48}#display #controls>div.active[data-action=option]{border-color:#66c;background-color:#66c}#display #controls>div.active[data-action=select]{border-color:#d73;background-color:#d73}#display #controls>div.active[data-action=start]{border-color:#5a3;background-color:#5a3}#display #controls>div.mapping{border-color:#e30;z-index:1001}#display #mapping-help{display:none;position:absolute;bottom:50%;width:100%;font-family:"m8stealth57";text-align:center}body.mapping #display #mapping-help{display:block}body.mapping #display #mapping-help .select-action{display:block}body.mapping #display #mapping-help .enter-input{display:none}body.mapping.capturing #display #mapping-help .select-action{display:none}body.mapping.capturing #display #mapping-help .enter-input{display:block;position:relative;z-index:1001}#capture-shield{display:none;position:fixed;top:0;bottom:0;left:0;right:0;background-color:rgba(0,0,0,.75);z-index:1000}body.mapping.capturing #capture-shield{display:block}#settings{position:fixed;top:0;bottom:0;left:0;right:0;background-color:rgba(0,0,0,.5);transition:background-color 80ms linear 0s;user-select:none}#settings.hidden{display:block;width:0;height:0;background-color:rgba(0,0,0,0)}#settings.hidden .setting{visibility:hidden;margin-left:-323px;transition:none}#settings.hidden #menu-button{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23fff' stroke-width='1.5' d='M2 4h12M2 8h12M2 12h12'/%3e%3c/svg%3e")}#settings.hidden.auto-hide #menu-button{opacity:0%;transition:opacity .8s linear .8s}#settings.hidden.auto-hide #menu-button:hover,#settings.hidden.auto-hide #menu-button:focus{opacity:100%;transition:opacity 0s}#settings #menu-button{width:32px;height:32px;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23fff' stroke-width='1.5' d='M3 3l10 10M3 13l10-10'/%3e%3c/svg%3e");background-repeat:no-repeat;background-color:rgba(0,0,0,0);border-color:rgba(0,0,0,0);font-size:0;margin-bottom:-3px}#settings #menu-button:hover{background-color:#00efff}#settings #menu-button:active{background-color:#00bfcc;color:#fff}#settings #menu-button:focus{color:#00efff;border-color:#00efff}#settings #menu-button:focus:hover{color:#000}#settings #menu-button:focus:active{color:#fff}#settings .setting{width:320px;border:3px solid #fff;border-width:3px 3px 0 0;margin-left:0;transition:margin-left 80ms linear 0s}#settings .setting:last-child{border-bottom-width:3px}#settings .setting label{display:block;position:relative;padding:10px}#settings .setting label input,#settings .setting label select{position:absolute;top:0;bottom:0;right:0;margin:0;border:0}#settings .setting label input[type=checkbox]{padding:10px}#settings .setting label select{width:50%}#settings .setting button{display:block;width:100%;margin:0;border:0;padding:10px}#firmware{position:fixed;top:0;bottom:0;left:0;right:0;padding:100px;background-color:rgba(0,0,0,.75);text-align:center;font-family:"m8stealth57";line-height:1.5}#firmware.hidden{display:none}#firmware p.select-file-msg,#firmware input[type=file],#firmware p.file-loading-msg,#firmware p.file-error-msg,#firmware p.select-device-msg,#firmware button.select-device,#firmware p.device-error-msg,#firmware p.flash-msg,#firmware button.flash,#firmware p.flashing-msg,#firmware progress.flash,#firmware p.flash-error-msg,#firmware p.flash-success-msg{display:none;margin:20px auto}#firmware p.file-error-msg,#firmware p.device-error-msg,#firmware p.flash-error-msg{color:#e22}#firmware.file-select p.select-file-msg,#firmware.file-select input[type=file]{display:block}#firmware.file-loading p.file-loading-msg{display:block}#firmware.file-loading button.close{display:none}#firmware.file-error p.select-file-msg,#firmware.file-error input[type=file],#firmware.file-error p.file-error-msg{display:block}#firmware.file-loaded p.select-device-msg,#firmware.file-loaded button.select-device{display:block}#firmware.device-error p.select-device-msg,#firmware.device-error button.select-device,#firmware.device-error p.device-error-msg{display:block}#firmware.device-selected p.flash-msg,#firmware.device-selected button.flash{display:block}#firmware.flashing p.flashing-msg,#firmware.flashing progress.flash{display:block}#firmware.flashing button.close{display:none}#firmware.flash-error p.select-device-msg,#firmware.flash-error button.select-device,#firmware.flash-error p.flash-error-msg{display:block}#firmware.flash-success p.flash-success-msg{display:block}#firmware button.close{display:block;position:absolute;right:100px;bottom:100px}#info{position:absolute;top:100px;left:100px;right:100px;padding:20px;background-color:rgba(0,0,0,.75);text-align:center;line-height:1.5}#info h1{font-family:"m8stealth57";font-size:32px;margin:0 0 16px}.error{position:absolute;top:100px;left:100px;right:100px;border:3px solid #fff;padding:20px;background-color:#a22;user-select:text}.error p{margin-top:0}.error p:last-child{margin-bottom:0}#reload{position:fixed;bottom:0;left:0;right:0;text-align:center}#reload button{border-bottom-width:0}

</style></head><body><div id="display"><canvas id="canvas" width="320" height="240"></canvas><div id="buttons" class="hidden"><button id="connect">Connect</button></div><div id="mapping-buttons"></div><div id="mapping-help"><p class="select-action">Click a key to add a new mapping</p><p class="enter-input">Press a keyboard key or gamepad button</p></div><div id="controls"><div data-action="edit" style="top: 2.0833%; left: 76.5625%"></div><div data-action="option" style="top: 2.0833%; left: 53.125%"></div><div data-action="up" style="top: 6.25%; left: 25%"></div><div data-action="left" style="top: 37.5%; left: 1.5625%"></div><div data-action="down" style="top: 37.5%; left: 25%"></div><div data-action="right" style="top: 37.5%; left: 48.4375%"></div><div data-action="select" style="top: 70.8333%; left: 27.3438%"></div><div data-action="start" style="top: 70.8333%; left: 50.7813%"></div></div></div><div id="serial-fail" class="error hidden"><p>Failed to connect over Serial.
Are you sure your Teensy is connected and the M8 Headless firmware is loaded?</p><p>Make sure that there are no other programs running which may have the serial port open.</p><p>On Linux you may also need make sure you have permission to open the serial port (eg. make yourself a member of the <code>dialout</code> group).</p><p>It is also possible there's a bug in this code.
There may be some messages in the developer console that will help with debugging.</p></div><div id="usb-fail" class="error hidden"><p>Failed to connect with WebUSB.
Are you sure your Teensy is connected and the M8 Headless firmware is loaded?</p><p>Connecting with WebUSB is known not to work on Windows or Linux.
Please make sure you are using an up to date version of Chrome or Edge (89+).</p></div><div id="no-serial-usb" class="error hidden"><p>Your browser doesn't appear to have Serial or WebUSB support.
These are only currently supported in Chrome and some Chrome-derived browsers.</p></div><div id="info"><h1>M8 Display</h1><p>This is a display for the <a href="https://github.com/DirtyWave/M8HeadlessFirmware" target="_blank" rel="noopener">M8 Headless firmware</a> running on a Teensy 4.1, or a <a href="https://dirtywave.com/" target="_blank" rel="noopener">real M8 device</a>.
You can use keyboard and gamepad input or use on-screen controls.
Where possible, the audio output from the M8 is routed to your default audio output device.
Firmware can be installed and updated from the menu.</p><p>By default the arrow keys on your keyboard map to the arrow keys on the M8.
Shift is <kbd>Left Shift</kbd>, Play is <kbd>Space</kbd>, Option is <kbd>Z</kbd>, and Edit is <kbd>X</kbd>.
These control mappings and other settings can be configured from the menu.</p><p>A virtual keyboard from <kbd>A</kbd> to <kbd>'</kbd> lets you send MIDI notes.
Use <kbd>-</kbd>/<kbd>=</kbd> to change octaves and <kbd>[</kbd>/<kbd>]</kbd> to change velocity.</p><p>Now that this page has loaded it will work completely offline.
All settings are stored locally by your browser.</p><p>Source code and more details are available at <a href="https://github.com/derkyjadex/M8WebDisplay" target="_blank" rel="noopener">github.com/<wbr>derkyjadex/<wbr>M8WebDisplay</a>.</p><button>OK</button></div><div id="settings" class="hidden"><button id="menu-button">Menu</button></div><div id="reload" class="hidden"><button>An update is available. Click to reload.</button></div><div id="capture-shield"></div><div id="firmware" class="hidden"><p class="select-file-msg">Select a firmware file</p><input type="file" accept=".hex"><p class="file-loading-msg">Loading file...</p><p class="file-error-msg">The selected file does not appear to be a valid Teensy 4.1 firmware file</p><p class="select-device-msg">Connect your Teensy board and press the little button on the board</p><button class="select-device">Select Teensy Device</button><p class="device-error-msg">The selected device does not appear to be a Teensy 4.1</p><p class="flash-msg">Ready to flash</p><button class="flash">Flash</button><p class="flashing-msg">Flashing...</p><progress class="flash"></progress><p class="flash-error-msg">There was an error flashing the device. You can try again.</p><p class="flash-success-msg">Flashing completed successfully</p><button class="close">Close</button></div><script>
function e(e){document.querySelectorAll(e).forEach((e=>e.classList.remove("hidden")))}function t(e){document.querySelectorAll(e).forEach((e=>e.classList.add("hidden")))}function r(e){return new Promise((t=>setTimeout(t,e)))}function a(e,t,r){const a=document.createElement("button");return a.innerText=t,n(a,"click",r),"string"==typeof e&&(e=document.querySelector(e)),e.append(a),a}function n(e,t,r,a){"string"==typeof e?e=document.querySelectorAll(e):e instanceof Array||(e=[e]);for(const n of e)n.addEventListener(t,r,a)}function i(e,t,r,a){e.removeEventListener(t,r,a)}class o{_device;_parser;_onConnectionChanged;_waitingForUserSelection;constructor(e,t){this._parser=e,this._onConnectionChanged=t,this._waitingForUserSelection=!1,n(navigator.usb,"connect",(e=>{this._waitingForUserSelection||this.connect(!0).catch((()=>{}))}))}get isConnected(){return!!this._device}async _startReading(){try{for(;this._device;){const e=await this._device.transferIn(3,512);"ok"!==e.status?this.disconnect():this._parser.process(new Uint8Array(e.data.buffer))}}catch(e){console.error(e),this.disconnect()}}async _send(e){if(this._device)try{await this._device.transferOut(3,new Uint8Array(e))}catch(e){console.error(e),this.disconnect()}}async sendKeys(e){this._send([67,e])}async sendNoteOn(e,t){this._send([75,e,t])}async sendNoteOff(){this._send([75,255])}async _reset(){await this._device.transferOut(3,new Uint8Array([68])),await r(50),this._parser.reset(),await this._device.transferOut(3,new Uint8Array([69,82]))}async disconnect(){const e=this._device;e&&(this._device=null,await e.transferOut(3,new Uint8Array([68])).catch((()=>{})),await e.close().catch((()=>{})),this._onConnectionChanged(!1))}async connect(e=!1){if(!this._device)try{const t=(await navigator.usb.getDevices()).filter((e=>5824===e.vendorId&&1162===e.productId));if(this._device=1===t.length?t[0]:null,this._device||(e?this._onConnectionChanged(!1):this._device=await this._requestDevice()),!this._device)return;await this._device.open(),await this._device.selectConfiguration(1),await this._device.claimInterface(1),await this._device.controlTransferOut({requestType:"class",recipient:"interface",request:34,value:3,index:1}),await this._device.controlTransferOut({requestType:"class",recipient:"interface",request:32,value:0,index:1},new Uint8Array([128,37,0,0,0,0,8])),await this._reset(),this._startReading(),this._onConnectionChanged(!0)}catch(e){throw console.error(e),this.disconnect(e),e}}async _requestDevice(){this._waitingForUserSelection=!0;try{return await navigator.usb.requestDevice({filters:[{vendorId:5824,productId:1162}]})}catch(e){if(e.code!==DOMException.NOT_FOUND_ERR)throw e;return null}finally{this._waitingForUserSelection=!1}}}class s{_port;_parser;_onConnectionChanged;_waitingForUserSelection;constructor(e,t){this._parser=e,this._onConnectionChanged=t,this._waitingForUserSelection=!1,n(navigator.serial,"connect",(e=>{this._waitingForUserSelection||this.connect(!0).catch((()=>{}))}))}get isConnected(){return!!this._port}async _startReading(){try{for(;this._port;){const{value:e,done:t}=await this._port.reader.read();if(e)try{this._parser.process(e)}catch(e){console.error(e)}if(t)return}}catch(e){console.error(e),this.disconnect()}}async _send(e){if(this._port&&this._port.writer)try{await this._port.writer.write(new Uint8Array(e))}catch(e){console.error(e),this.disconnect()}}async sendKeys(e){this._send([67,e])}async sendNoteOn(e,t){this._send([75,e,t])}async sendNoteOff(){this._send([75,255])}async _reset(){await this._port.writer.write(new Uint8Array([68])),await r(50),this._parser.reset(),await this._port.writer.write(new Uint8Array([69,82]))}async disconnect(){const e=this._port;e&&(this._port=null,e.writer&&await e.writer.write(new Uint8Array([68])).catch((()=>{})),e.reader&&await e.reader.cancel().catch((()=>{})),await e.close().catch((()=>{})),this._onConnectionChanged(!1))}async connect(e=!1){if(!this._port)try{const t=(await navigator.serial.getPorts()).filter((e=>{const t=e.getInfo();return 5824===t.usbVendorId&&1162===t.usbProductId}));if(this._port=1===t.length?t[0]:null,this._port||(e?this._onConnectionChanged(!1):this._port=await this._requestPort()),!this._port)return;await this._port.open({baudRate:9600,dataBits:8,stopBits:1,parity:"none",bufferSize:4096}),this._port.reader=await this._port.readable.getReader(),this._port.writer=await this._port.writable.getWriter(),await this._reset(),this._startReading(),this._onConnectionChanged(!0)}catch(e){throw console.error(e),this.disconnect(e),e}}async _requestPort(){this._waitingForUserSelection=!0;try{return await navigator.serial.requestPort({filters:[{usbVendorId:5824,usbProductId:1162}]})}catch(e){if(e.code!==DOMException.NOT_FOUND_ERR)throw e;return null}finally{this._waitingForUserSelection=!1}}}const c=Symbol("normal"),l=Symbol("escape"),u=Symbol("error"),d=new Uint8Array(0);var h=Object.freeze({__proto__:null,blit_vert:"#version 300 es\nout vec2 srcCoord;const vec2 corners[]=vec2[](vec2(0,0),vec2(0,1),vec2(1,0),vec2(1,1));void main(){vec2 pos =corners[gl_VertexID]*vec2(2.0,2.0)+vec2(-1.0,-1.0);gl_Position =vec4(pos,0.0,1.0);srcCoord =corners[gl_VertexID]*vec2(320.0,240.0);}",rect_vert:"#version 300 es\nlayout(location =0)in vec4 shape;layout(location =1)in vec3 colour;out vec3 colourV;const vec2 corners[]=vec2[](vec2(0,0),vec2(0,1),vec2(1,0),vec2(1,1));const vec2 camScale =vec2(2.0 /320.0,-2.0 /240.0);const vec2 camOffset =vec2(-160.0,-120.0);void main(){vec2 pos =shape.xy;vec2 size =shape.zw;pos =((corners[gl_VertexID]*size +pos)+camOffset)*camScale;gl_Position =vec4(pos,0.0,1.0);colourV =colour;}",text_vert:"#version 300 es\nlayout(location =0)in vec3 colour;layout(location =1)in float char;out vec3 colourV;out vec2 fontCoord;const vec2 corners[]=vec2[](vec2(0,0),vec2(0,1),vec2(1,0),vec2(1,1));const vec2 camScale =vec2(2.0 /320.0,-2.0 /240.0);const vec2 camOffset =vec2(-160.0,-120.0);const vec2 size =vec2(5.0,7.0);void main(){float row;float col =modf(float(gl_InstanceID)/40.0,row)*40.0;vec2 pos =vec2(col,row)*vec2(8.0,10.0)+vec2(0.0,3.0);pos =((corners[gl_VertexID]*size +pos)+camOffset)*camScale;gl_Position =vec4(char ==0.0 ? vec2(2.0): pos,0.0,1.0);colourV =colour;fontCoord =(vec2(char -1.0,0.0)+corners[gl_VertexID])*size;}",wave_vert:"#version 300 es\nlayout(location =0)in uint value;const vec2 camScale =vec2(2.0 /320.0,-2.0 /240.0);const vec2 camOffset =vec2(-160.0,-120.0);void main(){vec2 pos =vec2(float(gl_VertexID),float(value));pos =(pos +vec2(0.5)+camOffset)*camScale;gl_PointSize =1.0;gl_Position =vec4(pos,0.0,1.0);}",blit_frag:"#version 300 es\nprecision highp float;uniform sampler2D src;in vec2 srcCoord;out vec4 fragColour;void main(){fragColour =texelFetch(src,ivec2(srcCoord),0);}",rect_frag:"#version 300 es\nprecision highp float;in vec3 colourV;out vec4 fragColour;void main(){fragColour =vec4(colourV,1.0);}",text_frag:"#version 300 es\nprecision highp float;uniform sampler2D font;in vec2 fontCoord;in vec3 colourV;out vec4 fragColour;void main(){vec4 fontTexel =texelFetch(font,ivec2(fontCoord),0);fragColour =vec4(colourV,fontTexel.r);}",wave_frag:"#version 300 es\nprecision highp float;uniform vec3 colour;out vec4 fragColour;void main(){fragColour =vec4(colour,1.0);}"});function _(e,t,r){const a=e.createShader(r);if(e.shaderSource(a,h[t]),e.compileShader(a),!e.getShaderParameter(a,e.COMPILE_STATUS))throw new Error(`Failed to compile shader (${t}): ${e.getShaderInfoLog(a)}`);return a}function f(e,t){return function(e,t,r,a){const n=e.createProgram();if(e.attachShader(n,r),e.attachShader(n,a),e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS))throw new Error(`Failed to link program (${t}): ${e.getProgramInfoLog(n)}`);return n}(e,t,_(e,`${t}_vert`,e.VERTEX_SHADER),_(e,`${t}_frag`,e.FRAGMENT_SHADER))}let v=!1;function g(){v||(window.location.reload(),v=!0)}let p=()=>{};n("#reload button","click",(()=>p())),n("#menu-button","click",(()=>{return e="#settings",void document.querySelectorAll(e).forEach((e=>e.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden")));var e})),n("#settings","click",(e=>{"settings"===e.target.id&&t("#settings")}));const w={},m={};function b(e,t,r){const a=x(e,r),i=document.createElement("div");i.classList.add("setting");const o=document.createElement("label");o.innerText=t,i.append(o);const s=document.createElement("input");s.setAttribute("type","checkbox"),s.checked=a,o.append(s),n(s,"change",(()=>A(e,s.checked))),document.getElementById("settings").append(i)}function y(e,r){const n=document.createElement("div");n.classList.add("setting"),a(n,r,(()=>{t("#settings"),w[e]&&w[e]()})),document.getElementById("settings").append(n)}function x(e,t){let r=localStorage[e];return r=void 0===r?t:JSON.parse(r),m[e]=r,r}function A(e,t){m[e]=t,w[e]&&w[e](t),localStorage[e]=JSON.stringify(t)}function E(e,t){w[e]=t,void 0!==R(e)&&t(R(e))}function R(e){return m[e]}b("showControls","Show Controls",!1),b("hideMenu","Hide Menu",!1),b("enableAudio","Enable Audio",!0),function(e,t,r,a){const i=x(e,a),o=document.createElement("div");o.classList.add("setting");const s=document.createElement("label");s.innerText=t,o.append(s);const c=document.createElement("select");for(const[e,t]of Object.entries(r)){const r=document.createElement("option");r.value=e,r.text=t,c.append(r)}c.value=i,s.append(c),n(c,"change",(()=>A(e,c.value))),document.getElementById("settings").append(o)}("displayType","Display Type",{webgl2:"WebGL2",old:"Canvas + SVG"},"webgl2"),b("snapPixels","Snap Pixels",!0),b("virtualKeyboard","Virtual Keyboard",!0),b("preventSleep","Prevent Sleep",!1),y("controlMapping","Control Mapping"),y("firmware","Load Firmware"),y("fullscreen","Fullscreen"),y("about","About"),E("hideMenu",(e=>document.getElementById("settings").classList.toggle("auto-hide",e)));const T=Object.freeze({KeyA:0,KeyW:1,KeyS:2,KeyE:3,KeyD:4,KeyF:5,KeyT:6,KeyG:7,KeyY:8,KeyH:9,KeyU:10,KeyJ:11,KeyK:12,KeyO:13,KeyL:14,KeyP:15,Semicolon:16,Quote:17,BracketLeft:"velDown",BracketRight:"velUp",Minus:"octDown",Equal:"octUp"});let S,C,U=!0,F=3,D=103,B=null;let I=0;const k={up:6,down:5,left:7,right:2,select:4,start:3,option:1,edit:0},P=Object.freeze({ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",ShiftLeft:"select",Space:"start",KeyZ:"option",KeyX:"edit",Gamepad12:"up",Gamepad64:"up",Gamepad13:"down",Gamepad65:"down",Gamepad14:"left",Gamepad66:"left",Gamepad15:"right",Gamepad67:"right",Gamepad8:"select",Gamepad2:"select",Gamepad5:"select",Gamepad9:"start",Gamepad3:"start",Gamepad1:"option",Gamepad0:"edit"}),M={};function N(e,t,r){if(e)return H?(r&&r.preventDefault(),void(t&&H(e))):void(function(e,t,r){if(!U||!r||r.ctrlKey||r.metaKey||r.altKey)return!1;const a=T[e];if(void 0===a)return!1;if(r.repeat)return!0;switch(a){case"octDown":t&&(F=Math.max(F-1,0));break;case"octUp":t&&(F=Math.min(F+1,10));break;case"velDown":t&&(D=Math.max(D-8,7));break;case"velUp":t&&(D=Math.min(D+8,127));break;default:const e=a+12*F;if(e>128)return!1;t?(B=a,S.sendNoteOn(e,D)):a===B&&S.sendNoteOff()}return!0}(e,t,r)||V(M[e],t,r))}function O(e,t){const r=t.target.dataset.action;r&&(K&&e&&!H?async function(e,t){const r=e=>{e.stopPropagation(),Q()};n(document.body,"mousedown",r,!0),n(document.body,"touchstart",r,!0),document.body.classList.add("capturing"),e.classList.add("mapping");try{const a=await(Q(),new Promise((e=>{H=e})).then((e=>(H=null,e))));a&&(M[a]=t,A("inputMap",M))}finally{e.classList.remove("mapping"),document.body.classList.remove("capturing"),i(document.body,"touchstart",r,!0),i(document.body,"mousedown",r,!0)}}(t.target,r):V(r,e,t))}function V(e,t,r){if(!e)return;r&&r.preventDefault();const a=k[e];if(void 0===a)return;const n=t?I|1<<a:I&~(1<<a);n!==I&&(I=n,C.sendKeys(I),document.querySelector(`#controls > [data-action="${e}"]`).classList.toggle("active",t))}function L(e){C=e,function(e){S=e,E("virtualKeyboard",(e=>{U=e,S.sendNoteOff()}))}(C),n(document,"keydown",(e=>N(e.code,!0,e))),n(document,"keyup",(e=>N(e.code,!1,e)));const t=document.getElementById("controls");n(t,"mousedown",(e=>O(!0,e))),n(t,"touchstart",(e=>O(!0,e))),n(t,"mouseup",(e=>O(!1,e))),n(t,"touchend",(e=>O(!1,e))),a("#mapping-buttons","Reset to Default",z),a("#mapping-buttons","Clear All",Z),a("#mapping-buttons","Done",j),Object.assign(M,x("inputMap",P))}let G=!1;const $=[],q={0:[!0,!1,!1,!1],1:[!0,!1,!1,!0],2:[!1,!1,!1,!0],3:[!1,!0,!1,!0],4:[!1,!0,!1,!1],5:[!1,!0,!0,!1],6:[!1,!1,!0,!1],7:[!0,!1,!0,!1],8:[!1,!1,!1,!1],15:[!1,!1,!1,!1]};function Y(){if(!G)return;let e=!1;for(const t of navigator.getGamepads()){if(!t||!t.connected)continue;e=!0;let r=$[t.index];if(r||(r=$[t.index]={buttons:[],axes:Array(t.axes.length).fill(null).map((e=>({})))}),"standard"!==t.mapping)for(let e=0;e<t.axes.length;e++){if(!1===r.axes[e].isHat)continue;const a=3.5*(t.axes[e]+1),n=Math.abs(Math.round(a)-a),i=q[Math.round(a)];if(n>48e-8||void 0===i)r.axes[e].isHat=!1;else if(0!==a||!0===r.axes[e].isHat){r.axes[e].isHat=!0;for(let e=0;e<4;e++){const t=i[e];r.buttons[64+e]!==t&&(r.buttons[64+e]=t,N(`Gamepad${64+e}`,t))}}}for(let e=0;e<t.axes.length;e++){const a=t.axes[e];if(!0===r.axes[e].isHat||Math.abs(a)>1)continue;const n=a<=-.5,i=a>=.5;r.axes[e].negative!==n&&(r.axes[e].negative=n,N(`GamepadAxis${e}-`,n)),r.axes[e].positive!==i&&(r.axes[e].positive=i,N(`GamepadAxis${e}+`,i))}for(let e=0;e<t.buttons.length;e++){const a=t.buttons[e].pressed;r.buttons[e]!==a&&(r.buttons[e]=a,N(`Gamepad${e}`,a))}}e?requestAnimationFrame(Y):G=!1}n(window,"gamepadconnected",(e=>{"standard"!==e.gamepad.mapping&&console.warn("Non-standard gamepad attached. Mappings may be funny."),G||(G=!0,Y())})),n(window,"gamepaddisconnected",(e=>{$[e.gamepad.index]=null}));let X,K=!1,W=null,H=null;function j(){Q(),document.body.classList.remove("mapping"),K=!1,W&&W()}function Q(){H&&H(null)}function z(){for(const e of Object.keys(M))delete M[e];Object.assign(M,P),A("inputMap",M)}function Z(){for(const e of Object.keys(M))delete M[e];A("inputMap",M)}let J=!0;async function ee(e=1){if(!X&&J){try{let t;for(X=new AudioContext,await navigator.mediaDevices.getUserMedia({audio:!0});t=await te(),!t&&--e>0;)await r(300);if(!t)throw new Error("M8 not found");const a=await navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:t},autoGainControl:!1,echoCancellation:!1,noiseSuppression:!1}});X.createMediaStreamSource(a).connect(X.destination),"running"!==X.state&&function(){const e=["keydown","mousedown","touchstart"];function t(){X&&X.resume(),e.forEach((e=>i(document,e,t)))}e.forEach((e=>n(document,e,t)))}()}catch(e){console.error(e),re()}J||re()}}async function te(){return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audioinput"===e.kind&&/M8/.test(e.label)&&"default"!==e.deviceId&&"communications"!==e.deviceId)).map((e=>e.deviceId))[0]}async function re(){X&&await X.close().catch((()=>{})),X=null}const ae=Symbol("START_LINE"),ne=Symbol("HEX1"),ie=Symbol("HEX2");async function oe(e,t,r){const a=[];for await(let{address:n,data:i}of async function*(e){const t=new Uint8Array(260);let r=ae,a=1,n=0,i=0,o=0,s=0,c=1,l=!1,u=0;const d=e.stream().getReader();for(;;){const e=await d.read();if(!e.value)break;for(const d of e.value){if(n++,l)throw new ce(`Unexpected data after end record, line ${a} char ${n}`);switch(r){case ae:if(58!==d)throw new ce(`Expecting ':' at start of line ${a} char ${n}`);r=ne;break;case ne:if(13===d)continue;if(10===d){if(i<c)throw new ce(`Unexpected end of line on line ${a} char ${n}`);if(0!==s)throw new ce(`Invalid checksum on line ${a}`);switch(t[3]){case 0:yield{address:u+256*t[1]+t[2],data:t.subarray(4,c-1)};break;case 1:l=!0;break;case 2:u=256*t[4]+t[5]<<4;break;case 3:case 5:break;case 4:u=256*t[4]+t[5]<<16;break;default:throw new ce(`Invalid record type on line ${a}`)}r=ae,a++,n=0,i=0,s=0,c=1}else{if(i>=c)throw new ce(`Record too long on line ${a} char ${n}`);const e=se(d);if(null===e)throw new ce(`Expecting hex character on line ${a} char ${n}`);o=16*e,r=ie}break;case ie:const e=se(d);if(null===e)throw new ce(`Expecting hex character on line ${a} char ${n}`);o+=e,s=s+o&255,0===i&&(c=o+5),t[i++]=o,r=ne}}if(e.done)break}if(l)return;if(r!=ne||byte<c)throw new ce(`Unexpected end of file, line ${a} char ${n}`);if(0!==s)throw new ce(`Invalid checksum on line ${a}`);if(1!==t[3])throw new ce(`Missing end of file record, line ${a}`)}(e)){if(n-=r,n<0)throw new ce("Negative address after applying offset");let e=Math.floor(n/t),o=0;for(;o<i.length;){let r=a[e];r||(r=a[e]=new Uint8Array(t),r.fill(255));const s=e*t,c=s+t,l=n+o-s,u=n+i.length>c?t:l+i.length-o;for(let e=l;e<u;e++)r[e]=i[o++];e++}}return a}function se(e){return e>=48&&e<=57?e-48:e>=65&&e<=70?e-55:e>=97&&e<=102?e-87:null}class ce extends Error{constructor(...e){super(...e),this.name="HexFormatError"}}function le(e){document.getElementById("firmware").className=e}let ue=null,de=null;n("#firmware button.close","click",(()=>{ue=null,de=null,document.querySelector("#firmware input").value=null,le("hidden")})),n("#firmware input","change",(async e=>{ue=null;const t=e.target.files[0];if(t){le("file-loading");try{ue=await oe(t,1024,1610612736)}catch(e){return console.error(e),void le("file-error")}le("file-loaded")}})),n("#firmware button.select-device","click",(async()=>{de=null;const e=await navigator.hid.requestDevice({filters:[{vendorId:5824,productId:1144}]});de=e&&e[0],de&&(!function(e){const t=e.collections[0];return t&&65436===t.usagePage&&37===t.usage}(de)?(de=null,le("device-error")):le("device-selected"))})),n("#firmware button.flash","click",(async()=>{const e=document.querySelector("#firmware progress.flash");le("flashing");try{await async function(e,t,a){a(0),await t.open();try{const n=new Uint8Array(1088);for(let i=0;i<e.length;i++){if(0!==i&&(!e[i]||e[i].every((e=>255===e))))continue;const o=1024*i;n[0]=255&o,n[1]=o>>8&255,n[2]=o>>16&255,n.set(e[i],64),await t.sendReport(0,n),a((i+1)/e.length),await r(0===i?1500:5)}n.fill(0),n[0]=255,n[1]=255,n[2]=255,await t.sendReport(0,n)}finally{await t.close().catch((()=>{}))}}(ue,de,(t=>e.value=t))}catch(e){return console.error(e),void le("flash-error")}le("flash-success")}));let he=!1,_e=null;function fe(e){he=e,ve()}async function ve(){if(!navigator.wakeLock)return;const e=he&&R("preventSleep")&&"visible"===document.visibilityState,t=_e&&!_e.released;if(!e&&t)_e.release(),_e=null;else if(e&&!t)try{_e=await navigator.wakeLock.request("screen"),n(_e,"release",(()=>ve()))}catch{_e=null}}function ge(e,t,r){const a=`rgb(${e}, ${t}, ${r})`;document.body.style.backgroundColor=a,document.documentElement.style.backgroundColor=a,A("background",[e,t,r])}E("preventSleep",(()=>ve())),n(document,"visibilitychange",(()=>ve()));const pe=x("background",[0,0,0]);ge(pe[0],pe[1],pe[2]);const we="webgl2"===R("displayType")?new class{_canvas;_gl;_bg=[0,0,0];_frameQueued=!1;_onBackgroundChanged;constructor(e,t){this._bg=[e[0]/255,e[1]/255,e[2]/255],this._onBackgroundChanged=t,this._canvas=document.getElementById("canvas"),this._gl=this._canvas.getContext("webgl2",{alpha:!1,antialias:!1});const r=this._gl;this._setupRects(r),this._setupText(r),this._setupWave(r),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.viewport(0,0,320,240),this._queueFrame()}_rectShader;_rectVao;_rectShapes=new Uint16Array(6144);_rectColours=new Uint8Array(this._rectShapes.buffer,8);_rectCount=0;_rectsClear=!0;_rectsTex;_rectsFramebuffer;_blitShader;_setupRects(e){this._rectShader=f(e,"rect"),this._rectVao=e.createVertexArray(),e.bindVertexArray(this._rectVao),this._rectShapes.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._rectShapes.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._rectShapes,e.STREAM_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,4,e.UNSIGNED_SHORT,!1,12,0),e.vertexAttribDivisor(0,1),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,3,e.UNSIGNED_BYTE,!0,12,8),e.vertexAttribDivisor(1,1),this._rectsTex=e.createTexture(),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._rectsTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,320,240,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),this._rectsFramebuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._rectsFramebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this._rectsTex,0),this._blitShader=f(e,"blit"),e.useProgram(this._blitShader),e.uniform1i(e.getUniformLocation(this._blitShader,"src"),0)}_renderRects(e){this._rectsClear&&(e.bindFramebuffer(e.FRAMEBUFFER,this._rectsFramebuffer),e.clearColor(this._bg[0],this._bg[1],this._bg[2],1),e.clear(e.COLOR_BUFFER_BIT),this._rectsClear=!1),this._rectCount>0&&(e.bindFramebuffer(e.FRAMEBUFFER,this._rectsFramebuffer),e.useProgram(this._rectShader),e.bindVertexArray(this._rectVao),e.bindBuffer(e.ARRAY_BUFFER,this._rectShapes.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._rectShapes.subarray(0,6*this._rectCount)),e.drawArraysInstanced(e.TRIANGLE_STRIP,0,4,this._rectCount),this._rectCount=0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.useProgram(this._blitShader),e.drawArrays(e.TRIANGLE_STRIP,0,4)}drawRect(e,t,r,a,n,i,o){if(0===e&&0===t&&320===r&&240===a)this._onBackgroundChanged(n,i,o),this._bg=[n/255,i/255,o/255],this._rectCount=0,this._rectsClear=!0;else if(this._rectCount<1024){const s=this._rectCount;this._rectShapes[6*s+0]=e,this._rectShapes[6*s+1]=t,this._rectShapes[6*s+2]=r,this._rectShapes[6*s+3]=a,this._rectColours[12*s+0]=n,this._rectColours[12*s+1]=i,this._rectColours[12*s+2]=o,this._rectCount++}this._rectCount>=1024&&this._renderRects(this._gl),this._queueFrame()}_textShader;_textVao;_textTex;_textColours=new Uint8Array(2880);_textChars=new Uint8Array(960);_setupText(e){this._textShader=f(e,"text"),e.useProgram(this._textShader),e.uniform1i(e.getUniformLocation(this._textShader,"font"),1),this._textVao=e.createVertexArray(),e.bindVertexArray(this._textVao),this._textColours.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._textColours.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._textColours,e.DYNAMIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,3,e.UNSIGNED_BYTE,!0,0,0),e.vertexAttribDivisor(0,1),this._textChars.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._textChars.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._textChars,e.DYNAMIC_DRAW),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,1,e.UNSIGNED_BYTE,!1,0,0),e.vertexAttribDivisor(1,1),this._textTex=e.createTexture(),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this._textTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,470,7,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);const t=new Image;t.onload=()=>{e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this._textTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,470,7,0,e.RGBA,e.UNSIGNED_BYTE,t),this._queueFrame()},t.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdYAAAAHAQMAAACPwf4nAAAABlBMVEUAAAD///+l2Z/dAAABiElEQVQYGQXBwUtTcQDA8e/77dneYepTGBSocxakl9DhoUO45yiELpP8B6pBpwjFwwosf4qYF5vhpYsVZBBBYB2iYIdn5OZJEsJuMkg09LA3Efr9dHs/Px9mpdc/I4H0VZMwVQXWVn6l2thWOWdjN/9GlQYK5Zjr2LgdbvdbH8ADhrJSEC++sn4swPH3m3o4s0R3Mhcv9d262yuakmPx9VHQz9TFOnBCRUoAgD19xQ4/fot8SUvo8S4Dws0OPyeESqvdCADQpNNTGIB7mU8G0FtHu2MPBgU7739jfW2VmWjxoHjtUTCx0DXpRa+34ISqOXIDTmvSh+b7l5ZTvjgrpxaTo2jtiw+Cvtwa4e3azFwj0raZcik8ziz6evOOrVDHnfvszb+kAgFRy8cG6MI+nZAhQv5ZPQE8SwEg3M/jTxDgUwf++VhlQQBL6KceMWgZ/4lzoQ1A4g1aEq89YcJE/bXjwovCSnV9++yd2vj1cGqkfeB/qSNSMcYs1/I9h+UgNjT9t2bCrDwHUjqY5UZP3NUAAAAASUVORK5CYII="}_renderText(e){e.useProgram(this._textShader),e.bindVertexArray(this._textVao),this._textColours.updated&&(e.bindBuffer(e.ARRAY_BUFFER,this._textColours.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._textColours),this._textColours.updated=!1),this._textChars.updated&&(e.bindBuffer(e.ARRAY_BUFFER,this._textChars.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._textChars),this._textChars.updated=!1),e.drawArraysInstanced(e.TRIANGLE_STRIP,0,4,960)}drawText(e,t,r,a,n,i){const o=40*Math.floor(r/10)+Math.floor(t/8);this._textChars[o]=e-32,this._textChars.updated=!0,this._textColours[3*o+0]=a,this._textColours[3*o+1]=n,this._textColours[3*o+2]=i,this._textColours.updated=!0,this._queueFrame()}_waveData=new Uint8Array(320);_waveColour=new Float32Array([.5,1,1]);_waveOn=!1;_setupWave(e){this._waveShader=f(e,"wave"),this._waveShader.colourUniform=e.getUniformLocation(this._waveShader,"colour"),this._waveVao=e.createVertexArray(),e.bindVertexArray(this._waveVao),this._waveData.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._waveData.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._waveData,e.STREAM_DRAW),e.enableVertexAttribArray(0),e.vertexAttribIPointer(0,1,e.UNSIGNED_BYTE,1,0)}_renderWave(e){this._waveOn&&(e.useProgram(this._waveShader),e.uniform3fv(this._waveShader.colourUniform,this._waveColour),e.bindVertexArray(this._waveVao),this._waveData.updated&&(e.bindBuffer(e.ARRAY_BUFFER,this._waveData.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._waveData),this._waveData.updated=!1),e.drawArrays(e.POINTS,0,320))}drawWave(e,t,r,a){this._waveColour[0]=e/255,this._waveColour[1]=t/255,this._waveColour[2]=r/255,320==a.length?(this._waveData.set(a),this._waveData.updated=!0,this._waveOn=!0,this._queueFrame()):this._waveOn&&(this._waveOn=!1,this._queueFrame())}_renderFrame(){const e=this._gl;this._renderRects(e),this._renderText(e),this._renderWave(e),this._frameQueued=!1}_queueFrame(){this._frameQueued||(requestAnimationFrame((()=>this._renderFrame())),this._frameQueued=!0)}clear(){this._rectsClear=!0,this._rectCount=0,this._textChars.fill(0),this._textChars.updated=!0,this._waveOn=!1,this._queueFrame()}}(pe,ge):new class{_canvas;_ctx;_textNodes=[];_backgroundColour="rgb(0, 0, 0)";_frameQueued=!1;_rects=[];_waveColour="rgb(255, 255, 255)";_waveData=new Uint8Array(320);_waveOn=!1;_textUpdates={};_onBackgroundChanged;constructor(e,t){this._backgroundColour=`rgb(${e[0]}, ${e[1]}, ${e[2]})`,this._onBackgroundChanged=t,this._canvas=document.getElementById("canvas"),this._ctx=canvas.getContext("2d"),this._buildText()}_buildText(){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");for(t.setAttributeNS(null,"viewBox","0 0 640 480");t.firstChild;)t.removeChild(t.lastChild);for(let r=0;r<25;r++)for(let a=0;a<39;a++){const n=document.createElementNS(e,"text");n.setAttributeNS(null,"x",16*a),n.setAttributeNS(null,"y",20*r+20),n.setAttributeNS(null,"fill","_000");const i=document.createTextNode("");n.appendChild(i),t.appendChild(n),this._textNodes[39*r+a]={node:i,char:32,fill:"_000"}}this._canvas.insertAdjacentElement("afterend",t)}_renderFrame(){for(let e=0;e<this._rects.length;e++){const t=this._rects[e];this._ctx.fillStyle=t.colour,this._ctx.fillRect(t.x,t.y,t.w,t.h)}if(this._rects.length=0,this._waveUpdated&&(this._ctx.fillStyle=this._backgroundColour,this._ctx.fillRect(0,0,320,21),this._waveOn)){this._ctx.fillStyle=this._waveColour;for(let e=0;e<this._waveData.length;e++){const t=Math.min(this._waveData[e],20);this._ctx.fillRect(e,t,1,1)}}this._waveUpdated=!1;for(const[e,t]of Object.entries(this._textUpdates)){const e=t.node;t.char!==e.char&&(e.node.nodeValue=String.fromCharCode(t.char),e.char=t.char),t.fill!==e.fill&&(e.node.parentElement.setAttributeNS(null,"fill",t.fill),e.fill=t.fill)}this._textUpdates={},this._frameQueued=!1}_queueFrame(){this._frameQueued||(requestAnimationFrame((()=>this._renderFrame())),this._frameQueued=!0)}drawRect(e,t,r,a,n,i,o){const s=`rgb(${n}, ${i}, ${o})`;0===e&&0===t&&320===r&&240===a&&(this._rects.length=0,this._backgroundColour=s,this._onBackgroundChanged(n,i,o)),this._rects.push({colour:s,x:e,y:t,w:r,h:a}),this._queueFrame()}drawText(e,t,r,a,n,i){const o=39*Math.floor(r/10)+Math.floor(t/8);this._textNodes[o]&&(this._textUpdates[o]={node:this._textNodes[o],char:e,fill:`rgb(${a}, ${n}, ${i})`},this._queueFrame())}drawWave(e,t,r,a){this._waveColour=`rgb(${e}, ${t}, ${r})`,320==a.length?(this._waveData.set(a),this._waveOn=!0,this._waveUpdated=!0,this._queueFrame()):this._waveOn&&(this._waveOn=!1,this._waveUpdated=!0,this._queueFrame())}clear(){this._rects=[{colour:this._backgroundColour,x:0,y:0,w:320,h:240}],this._waveOn=!1,this._waveUpdated=!0,this._textUpdates={};for(let e=0;e<this._textNodes.length;e++)this._textUpdates[e]={node:this._textNodes[e],char:32,fill:"rgb(0, 0, 0)"};this._queueFrame()}}(pe,ge),me=new class{_state=c;_buffer=new Uint8Array(512);_i=0;_renderer;constructor(e){this._renderer=e}_processFrame(e){switch(e[0]){case 254:12===e.length?this._renderer.drawRect(e[1]+256*e[2],e[3]+256*e[4],e[5]+256*e[6],e[7]+256*e[8],e[9],e[10],e[11]):console.log("Bad RECT frame");break;case 253:12===e.length?this._renderer.drawText(e[1],e[2]+256*e[3],e[4]+256*e[5],e[6],e[7],e[8]):console.log("Bad TEXT frame");break;case 252:4===e.length?this._renderer.drawWave(e[1],e[2],e[3],d):324===e.length?this._renderer.drawWave(e[1],e[2],e[3],e.subarray(4)):console.log("Bad WAVE frame");break;case 251:3!==e.length&&console.log("Bad JPAD frame");break;default:console.log("BAD FRAME")}}process(e){for(let t=0;t<e.length;t++){const r=e[t];switch(this._state){case c:switch(r){case 192:this._processFrame(this._buffer.subarray(0,this._i)),this._i=0;break;case 219:this._state=l;break;default:this._buffer[this._i++]=r}break;case l:switch(r){case 220:this._buffer[this._i++]=192,this._state=c;break;case 221:this._buffer[this._i++]=219,this._state=c;break;default:this._state=u,console.log("Unexpected SLIP sequence")}break;case u:if(192===r)this._state=c,this._i=0,console.log("SLIP recovered")}}}reset(){this._state=c,this._i=0}}(we);let be=function(){const e=document.getElementById("display"),t=document.getElementById("canvas"),r=document.querySelector("#canvas + svg");function a(){const a=devicePixelRatio,n=e.clientWidth*a;if(R("snapPixels")&&n<=1600){let i=e.clientHeight*a;(R("showControls")||K)&&(i/=2);const o=320*Math.floor(n/320)/a,s=240*Math.floor(i/240)/a,c=Math.round((n/a-o)/2),l=Math.round((i/a-s)/2);t.style.width=`${o}px`,t.style.height=`${s}px`,t.style.left=`${c}px`,t.style.top=`${l}px`,r&&(r.style.width=`${o}px`,r.style.height=`${s}px`,r.style.left=`${c}px`,r.style.top=`${l}px`)}else t.style.width=null,t.style.height=null,t.style.left=null,t.style.top=null,r&&(r.style.width=null,r.style.height=null,r.style.left=null,r.style.top=null)}return n(window,"resize",a),window.matchMedia("screen and (min-resolution: 2dppx)").addListener(a),a(),a}();function ye(r){r?(t("#buttons, .error, #info"),ee(10)):(we.clear(),e("#buttons"),re()),fe(r)}function xe(r,a){L(r),n("#connect","click",(()=>r.connect().catch((()=>{t("#info"),e(a)})))),n(window,"beforeunload",(e=>r.disconnect())),r.connect(!0).catch((()=>{}))}E("showControls",(e=>{document.getElementById("display").classList.toggle("with-controls",e),be()})),E("enableAudio",(e=>{e?J||(J=!0,ee()):(J=!1,re())})),E("snapPixels",(()=>be())),E("controlMapping",(()=>{t("#info"),(K=!0,document.body.classList.add("mapping"),new Promise((e=>{W=e}))).then(be),be()})),E("firmware",(()=>{t("#info"),ue=null,de=null,le("file-select")})),E("fullscreen",(()=>{document.fullscreenElement?document.exitFullscreen():document.body.requestFullscreen()})),E("about",(()=>e("#info"))),navigator.serial?xe(new s(me,ye),"#serial-fail"):navigator.usb?xe(new o(me,ye),"#usb-fail"):e("#no-serial-usb"),n("#info button","click",(()=>t("#info"))),async function(){n(navigator.serviceWorker,"controllerchange",(()=>g()));let t=!navigator.serviceWorker.controller;const r=await navigator.serviceWorker.register("worker.js");n(r,"updatefound",(()=>{if(t)return void(t=!1);const a=r.installing;n(a,"statechange",(()=>{"installed"===a.state&&(p=navigator.serviceWorker.controller?()=>a.postMessage({action:"skipWaiting"}):g,e("#reload"))}))})),setInterval((()=>r.update()),18e5)}();

</script></body></html>
